@page "/perfumes/edit/{Id:int}"

@using System.ComponentModel.DataAnnotations
@using System.IO
@using System.Linq
@using FragranceDiaryBase.Shared.Models
@using FragranceDiaryBase.Shared.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms

@inject FragranceDbContext Db
@inject NavigationManager Nav

<h1>Edit Perfume</h1>

@if (!IsLoaded)
{
    <p>Loading...</p>
}
else if (LoadFailed)
{
    <p class="text-danger">Perfume not found.</p>
}
else
{
    <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Name -->
        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="Model.Name" />
        </div>

        <!-- Brand -->
        <div class="mb-3">
            <label class="form-label">Brand</label>

            <select class="form-select" @bind="Model.SelectedBrandId">
                <option value="0">(Select brand)</option>
                @foreach (var b in Brands)
                {
                    <option value="@b.Id">@b.Name</option>
                }
                <option value="-1">+ Add new brand...</option>
            </select>

            @if (Model.SelectedBrandId == -1)
            {
                <div class="mt-2">
                    <label class="form-label">New brand name</label>
                    <InputText class="form-control" @bind-Value="Model.NewBrandName" />
                </div>
            }
        </div>

        <!-- Volume -->
        <div class="mb-3">
            <label class="form-label">Volume (ml)</label>
            <InputNumber class="form-control" @bind-Value="Model.VolumeMl" />
            <div class="form-text">
                Size tag is calculated automatically from ml.
            </div>
        </div>

        <!-- Gender profile -->
        <div class="mb-3">
            <label class="form-label">Gender profile</label>
            <InputSelect class="form-select" @bind-Value="Model.GenderProfile">
                @foreach (GenderProfile gp in Enum.GetValues(typeof(GenderProfile)))
                {
                    <option value="@gp">@GetGenderDisplay(gp)</option>
                }
            </InputSelect>
        </div>

        <hr />

        <!-- Photo -->
        <h3>Photo</h3>
        <div class="mb-3">
            @if (!string.IsNullOrEmpty(CurrentPhotoPath))
            {
                <div class="mb-2">
                    <label class="form-label">Current photo</label>
                    <div>
                        <img src="@CurrentPhotoPath"
                             alt="Current perfume photo"
                             style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px;" />
                    </div>
                </div>
            }

            <label class="form-label">Change photo (optional)</label>
            <InputFile OnChange="OnFileSelected" accept="image/*" />

            @if (!string.IsNullOrEmpty(UploadedPhotoPath) && UploadedPhotoPath != CurrentPhotoPath)
            {
                <div class="mt-2">
                    <small class="text-muted">New photo preview:</small>
                    <img src="@UploadedPhotoPath"
                         alt="New perfume photo preview"
                         style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px;" />
                </div>
            }
        </div>

        <hr />

        <!-- Vibes -->
        <h3>Vibes</h3>
        <div class="mb-3 d-flex">
            <InputText class="form-control me-2"
                       placeholder="e.g. Great date night"
                       @bind-Value="NewVibeText" />
            <button type="button" class="btn btn-secondary" @onclick="AddVibe">Add vibe</button>
        </div>

        @if (Vibes.Any())
        {
            <ul class="list-group mb-3">
                @foreach (var vibe in Vibes)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        @vibe
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                @onclick="@(() => RemoveVibe(vibe))">
                            ×
                        </button>
                    </li>
                }
            </ul>
        }

        <hr />

        <!-- Notes -->
        <h3>Notes</h3>
        <p class="form-text">
            Choose notes for each level. All notes share one master list.
        </p>

        <!-- Top notes -->
        <h5>Top notes</h5>
        <div class="mb-3 d-flex">
            <select class="form-select me-2" @bind="SelectedTopNoteId">
                <option value="0">(Select top note)</option>
                @foreach (var note in Notes)
                {
                    <option value="@note.Id">@note.Name</option>
                }
                <option value="-1">+ Add new note...</option>
            </select>

            @if (SelectedTopNoteId == -1)
            {
                <InputText class="form-control me-2"
                           placeholder="New top note"
                           @bind-Value="NewTopNoteName" />
            }

            <button type="button" class="btn btn-secondary" @onclick="AddTopNote">Add</button>
        </div>

        <!-- Heart notes -->
        <h5>Heart notes</h5>
        <div class="mb-3 d-flex">
            <select class="form-select me-2" @bind="SelectedHeartNoteId">
                <option value="0">(Select heart note)</option>
                @foreach (var note in Notes)
                {
                    <option value="@note.Id">@note.Name</option>
                }
                <option value="-1">+ Add new note...</option>
            </select>

            @if (SelectedHeartNoteId == -1)
            {
                <InputText class="form-control me-2"
                           placeholder="New heart note"
                           @bind-Value="NewHeartNoteName" />
            }

            <button type="button" class="btn btn-secondary" @onclick="AddHeartNote">Add</button>
        </div>

        <!-- Base notes -->
        <h5>Base notes</h5>
        <div class="mb-3 d-flex">
            <select class="form-select me-2" @bind="SelectedBaseNoteId">
                <option value="0">(Select base note)</option>
                @foreach (var note in Notes)
                {
                    <option value="@note.Id">@note.Name</option>
                }
                <option value="-1">+ Add new note...</option>
            </select>

            @if (SelectedBaseNoteId == -1)
            {
                <InputText class="form-control me-2"
                           placeholder="New base note"
                           @bind-Value="NewBaseNoteName" />
            }

            <button type="button" class="btn btn-secondary" @onclick="AddBaseNote">Add</button>
        </div>

        <!-- Current note list -->
        @if (NoteRows.Any())
        {
            <ul class="list-group mb-3">
                @foreach (var row in NoteRows)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            @row.Name
                            <span class="badge bg-primary ms-2">@row.Type</span>
                        </span>
                        <button type="button"
                                class="btn btn-sm btn-outline-danger"
                                @onclick="@(() => RemoveNote(row))">
                            ×
                        </button>
                    </li>
                }
            </ul>
        }

        <hr />

        <button type="submit" class="btn btn-primary" disabled="@IsSaving">
            @(IsSaving ? "Saving..." : "Save Changes")
        </button>

        <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel">
            Cancel
        </button>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    public class EditPerfumeModel
    {
        [Required]
        public string Name { get; set; } = string.Empty;

        public int SelectedBrandId { get; set; } = 0;
        public string? NewBrandName { get; set; }

        [Range(1, 1000, ErrorMessage = "Volume must be at least 1 ml.")]
        public int VolumeMl { get; set; }

        [Required]
        public GenderProfile GenderProfile { get; set; } = GenderProfile.PerfectUnisex;
    }

    public class NoteRow
    {
        public string Name { get; set; } = string.Empty;
        public NoteType Type { get; set; }
    }

    private EditPerfumeModel Model { get; set; } = new();
    private Perfume? PerfumeEntity;

    private List<Brand> Brands { get; set; } = new();
    private List<Note> Notes { get; set; } = new();

    private List<string> Vibes { get; set; } = new();
    private string? NewVibeText { get; set; }

    private List<NoteRow> NoteRows { get; set; } = new();

    private int SelectedTopNoteId { get; set; } = 0;
    private int SelectedHeartNoteId { get; set; } = 0;
    private int SelectedBaseNoteId { get; set; } = 0;

    private string? NewTopNoteName { get; set; }
    private string? NewHeartNoteName { get; set; }
    private string? NewBaseNoteName { get; set; }

    // photo
    private IBrowserFile? UploadedFile;
    private string? CurrentPhotoPath;
    private string? UploadedPhotoPath;

    private bool IsSaving { get; set; }
    private bool IsLoaded { get; set; }
    private bool LoadFailed { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        Brands = await Db.Brands
            .OrderBy(b => b.Name)
            .ToListAsync();

        Notes = await Db.Notes
            .OrderBy(n => n.Name)
            .ToListAsync();

        PerfumeEntity = await Db.Perfumes
            .Include(p => p.Brand)
            .Include(p => p.Notes).ThenInclude(pn => pn.Note)
            .Include(p => p.Vibes)
            .FirstOrDefaultAsync(p => p.Id == Id);

        if (PerfumeEntity is null)
        {
            LoadFailed = true;
            IsLoaded = true;
            return;
        }

        Model = new EditPerfumeModel
        {
            Name = PerfumeEntity.Name,
            VolumeMl = PerfumeEntity.VolumeMl,
            SelectedBrandId = PerfumeEntity.BrandId,
            GenderProfile = PerfumeEntity.GenderProfile
        };

        CurrentPhotoPath = PerfumeEntity.PhotoPath;
        UploadedPhotoPath = CurrentPhotoPath;

        Vibes = PerfumeEntity.Vibes
            .Select(v => v.Text)
            .ToList();

        NoteRows = PerfumeEntity.Notes
            .Select(n => new NoteRow
            {
                Name = n.Note.Name,
                Type = n.NoteType
            })
            .ToList();

        IsLoaded = true;
    }

    private void Cancel()
    {
        Nav.NavigateTo("/library");
    }

    // Display text for GenderProfile dropdown
    private string GetGenderDisplay(GenderProfile gp) => gp switch
    {
        GenderProfile.FeminineLeaning => "Feminine leaning",
        GenderProfile.MasculineLeaning => "Masculine leaning",
        GenderProfile.PerfectUnisex => "Perfect unisex",
        _ => gp.ToString()
    };

    // ----- Photo upload -----
    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        UploadedFile = e.File;

        if (UploadedFile is null)
        {
            UploadedPhotoPath = CurrentPhotoPath;
            return;
        }

        var contentRoot = Directory.GetCurrentDirectory();
        var uploadsFolder = Path.Combine(contentRoot, "wwwroot", "images", "perfumes");
        Directory.CreateDirectory(uploadsFolder);

        var ext = Path.GetExtension(UploadedFile.Name);
        if (string.IsNullOrWhiteSpace(ext))
        {
            ext = ".jpg";
        }

        var fileName = $"{Guid.NewGuid()}{ext}";
        var filePath = Path.Combine(uploadsFolder, fileName);

        await using var readStream = UploadedFile.OpenReadStream(10 * 1024 * 1024);
        await using var fileStream = File.Create(filePath);
        await readStream.CopyToAsync(fileStream);

        UploadedPhotoPath = $"/images/perfumes/{fileName}";
    }

    // ----- Vibes -----
    private void AddVibe()
    {
        if (!string.IsNullOrWhiteSpace(NewVibeText))
        {
            var trimmed = NewVibeText.Trim();
            if (!Vibes.Contains(trimmed, StringComparer.OrdinalIgnoreCase))
            {
                Vibes.Add(trimmed);
            }
            NewVibeText = string.Empty;
        }
    }

    private void RemoveVibe(string vibe)
    {
        Vibes.Remove(vibe);
    }

    // Notes helpers
    private string? ResolveNoteName(int selectedId, string? newName)
    {
        if (selectedId > 0)
        {
            var note = Notes.FirstOrDefault(n => n.Id == selectedId);
            return note?.Name;
        }

        if (selectedId == -1)
        {
            return string.IsNullOrWhiteSpace(newName) ? null : newName.Trim();
        }

        return null;
    }

    private void AddNoteRow(string? name, NoteType type)
    {
        if (string.IsNullOrWhiteSpace(name))
            return;

        var trimmed = name.Trim();

        if (!NoteRows.Any(n =>
                n.Name.Equals(trimmed, StringComparison.OrdinalIgnoreCase) &&
                n.Type == type))
        {
            NoteRows.Add(new NoteRow
            {
                Name = trimmed,
                Type = type
            });
        }
    }

    private void AddTopNote()
    {
        var name = ResolveNoteName(SelectedTopNoteId, NewTopNoteName);
        AddNoteRow(name, NoteType.Top);
        SelectedTopNoteId = 0;
        NewTopNoteName = string.Empty;
    }

    private void AddHeartNote()
    {
        var name = ResolveNoteName(SelectedHeartNoteId, NewHeartNoteName);
        AddNoteRow(name, NoteType.Heart);
        SelectedHeartNoteId = 0;
        NewHeartNoteName = string.Empty;
    }

    private void AddBaseNote()
    {
        var name = ResolveNoteName(SelectedBaseNoteId, NewBaseNoteName);
        AddNoteRow(name, NoteType.Base);
        SelectedBaseNoteId = 0;
        NewBaseNoteName = string.Empty;
    }

    private void RemoveNote(NoteRow row)
    {
        NoteRows.Remove(row);
    }

    private async Task HandleValidSubmit()
    {
        if (PerfumeEntity is null)
            return;

        IsSaving = true;

        try
        {
            // Brand resolution
            Brand brand;

            if (Model.SelectedBrandId == -1)
            {
                if (string.IsNullOrWhiteSpace(Model.NewBrandName))
                {
                    throw new InvalidOperationException("Please enter a new brand name.");
                }

                var newBrandName = Model.NewBrandName.Trim();

                brand = await Db.Brands
                    .FirstOrDefaultAsync(b => b.Name == newBrandName)
                    ?? new Brand { Name = newBrandName };

                if (brand.Id == 0)
                {
                    Db.Brands.Add(brand);
                    await Db.SaveChangesAsync();
                }
            }
            else if (Model.SelectedBrandId > 0)
            {
                brand = await Db.Brands.FindAsync(Model.SelectedBrandId)
                        ?? throw new InvalidOperationException("Selected brand not found.");
            }
            else
            {
                throw new InvalidOperationException("Please select a brand or choose 'Add new brand...'.");
            }

            PerfumeEntity.Name = Model.Name.Trim();
            PerfumeEntity.BrandId = brand.Id;
            PerfumeEntity.VolumeMl = Model.VolumeMl;
            PerfumeEntity.GenderProfile = Model.GenderProfile;
            PerfumeEntity.UpdatedAt = DateTime.UtcNow;

            if (!string.IsNullOrWhiteSpace(UploadedPhotoPath))
            {
                PerfumeEntity.PhotoPath = UploadedPhotoPath;
            }

            if (!string.IsNullOrWhiteSpace(NewVibeText))
            {
                AddVibe();
            }

            // Replace notes
            var existingPerfumeNotes = await Db.PerfumeNotes
                .Where(pn => pn.PerfumeId == PerfumeEntity.Id)
                .ToListAsync();
            Db.PerfumeNotes.RemoveRange(existingPerfumeNotes);

            if (NoteRows.Any())
            {
                var distinctNames = NoteRows
                    .Select(n => n.Name)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .ToList();

                var existingNotes = await Db.Notes
                    .Where(n => distinctNames.Contains(n.Name))
                    .ToListAsync();

                foreach (var row in NoteRows)
                {
                    var note = existingNotes
                        .FirstOrDefault(n => n.Name.Equals(row.Name, StringComparison.OrdinalIgnoreCase));

                    if (note is null)
                    {
                        note = new Note { Name = row.Name };
                        Db.Notes.Add(note);
                        existingNotes.Add(note);
                        await Db.SaveChangesAsync();
                    }

                    Db.PerfumeNotes.Add(new PerfumeNote
                    {
                        PerfumeId = PerfumeEntity.Id,
                        NoteId = note.Id,
                        NoteType = row.Type
                    });
                }
            }

            // Replace vibes
            var existingVibes = await Db.VibeTags
                .Where(v => v.PerfumeId == PerfumeEntity.Id)
                .ToListAsync();
            Db.VibeTags.RemoveRange(existingVibes);

            foreach (var vibe in Vibes)
            {
                Db.VibeTags.Add(new VibeTag
                {
                    PerfumeId = PerfumeEntity.Id,
                    Text = vibe
                });
            }

            await Db.SaveChangesAsync();

            Nav.NavigateTo("/library");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            IsSaving = false;
        }
    }
}


